@page "/admin/connections"
@using Microsoft.EntityFrameworkCore
@using MyrtilleRDPManager.Data
@inject AppDbContext DbContext
@inject NavigationManager NavManager
@inject IJSRuntime JS

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Sunucu Listesi</h2>
        <button class="btn btn-primary" @onclick="CreateNew">
            <span class="oi oi-plus"></span> Yeni Sunucu Ekle
        </button>
    </div>

    @if (connections == null)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status"></div>
            <span class="ms-2">Yükleniyor...</span>
        </div>
    }
    else if (connections.Count == 0)
    {
        <div class="alert alert-warning">
            Hiç kayıt bulunamadı. Yeni bir sunucu ekleyerek başlayın.
        </div>
    }
    else
    {
        <table class="table table-hover table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Ad</th>
                    <th>Host (IP/DNS)</th>
                    <th>Kullanıcı</th>
                    <th>Protokol</th>
                    <th style="width: 180px;" class="text-end">İşlemler</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in connections)
                {
                    <tr>
                        <td class="fw-bold">@item.Name</td>
                        <td>@item.Host</td>
                        <td>@item.RemoteUsername</td>
                        <td><span class="badge bg-secondary">@item.Protocol</span></td>
                        <td class="text-end">
                            <a href="connect/@item.Id" class="btn btn-sm btn-success me-1" title="Bağlan">
                                <span class="oi oi-monitor"></span>
                            </a>
                            <button class="btn btn-sm btn-warning me-1" @onclick="() => Edit(item.Id)" title="Düzenle">
                                <span class="oi oi-pencil"></span>
                            </button>
                            <button class="btn btn-sm btn-danger" @onclick="() => Delete(item)" title="Sil">
                                <span class="oi oi-trash"></span>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    private List<Connection>? connections;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        // Veritabanından listeyi çekiyoruz
        connections = await DbContext.Connections.AsNoTracking().ToListAsync();
    }

    private void CreateNew()
    {
        NavManager.NavigateTo("/admin/connections/new");
    }

    private void Edit(int id)
    {
        NavManager.NavigateTo($"/admin/connections/edit/{id}");
    }

    private async Task Delete(Connection item)
    {
        if (!await JS.InvokeAsync<bool>("confirm", $"'{item.Name}' kaydını silmek istediğine emin misin?"))
            return;

        DbContext.Connections.Remove(item);
        await DbContext.SaveChangesAsync();
        await LoadData(); // Listeyi yenile
    }
}